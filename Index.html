<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Inventario</title>
    <meta name="theme-color" content="#4a90e2"/>
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4a90e2/ffffff?text=App">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        .modal {
            transition: opacity 0.25s ease;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Contenedor principal de la aplicación -->
    <div id="app-container" class="max-w-4xl mx-auto">

        <!-- ===== PÁGINA DE LOGIN ===== -->
        <div id="login-page" class="page active">
            <div class="flex items-center justify-center min-h-screen">
                <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm">
                    <h1 class="text-2xl font-bold text-center mb-6 text-gray-700">Iniciar Sesión</h1>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="username" class="block text-sm font-medium text-gray-600 mb-1">Usuario</label>
                            <input type="text" id="username" value="admin" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium text-gray-600 mb-1">Contraseña</label>
                            <input type="password" id="password" value="admin123" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">Ingresar</button>
                        <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                    </form>
                </div>
            </div>
        </div>

        <!-- ===== CONTENIDO PRINCIPAL (POST-LOGIN) ===== -->
        <div id="main-content" class="hidden">
            <header class="bg-white shadow-md sticky top-0 z-10">
                <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
                    <h1 class="text-xl font-bold text-blue-600">GestorApp</h1>
                    <div>
                        <button data-page="entries-page" class="nav-btn px-3 py-2 text-sm font-medium text-gray-600 hover:text-blue-600">Mercadería</button>
                        <button data-page="products-page" class="nav-btn px-3 py-2 text-sm font-medium text-gray-600 hover:text-blue-600">Productos</button>
                        <button data-page="suppliers-page" class="nav-btn px-3 py-2 text-sm font-medium text-gray-600 hover:text-blue-600">Proveedores</button>
                        <button id="logout-btn" class="ml-4 px-3 py-2 text-sm font-medium text-red-500 hover:text-red-700">Salir</button>
                    </div>
                </nav>
            </header>

            <main class="p-4 md:p-6">
                <!-- ===== PÁGINA DE INGRESO DE MERCADERÍA ===== -->
                <div id="entries-page" class="page">
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <h2 class="text-2xl font-bold mb-4">Ingreso de Mercadería</h2>
                        <form id="entry-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <input type="hidden" id="entry-id">
                            <div>
                                <label for="entry-date" class="block text-sm font-medium">Fecha</label>
                                <input type="date" id="entry-date" class="mt-1 w-full p-2 border rounded-lg" required>
                            </div>
                            <div>
                                <label for="entry-product" class="block text-sm font-medium">Producto</label>
                                <select id="entry-product" class="mt-1 w-full p-2 border rounded-lg" required></select>
                            </div>
                            <div>
                                <label for="entry-supplier" class="block text-sm font-medium">Proveedor</label>
                                <select id="entry-supplier" class="mt-1 w-full p-2 border rounded-lg" required></select>
                            </div>
                            <div>
                                <label for="entry-quantity" class="block text-sm font-medium">Cantidad</label>
                                <input type="number" step="any" id="entry-quantity" placeholder="Ej: 10.5" class="mt-1 w-full p-2 border rounded-lg" required>
                            </div>
                            <div>
                                <label for="entry-price" class="block text-sm font-medium">Precio Unitario</label>
                                <input type="number" step="any" id="entry-price" placeholder="Ej: 150.75" class="mt-1 w-full p-2 border rounded-lg" required>
                            </div>
                            <div>
                                <label for="entry-total" class="block text-sm font-medium">Total</label>
                                <input type="text" id="entry-total" class="mt-1 w-full p-2 border rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label for="entry-payment" class="block text-sm font-medium">Pago</label>
                                <input type="number" step="any" id="entry-payment" placeholder="Ej: 1000" class="mt-1 w-full p-2 border rounded-lg" required>
                            </div>
                            <div>
                                <label for="payment-type" class="block text-sm font-medium">Tipo de Pago</label>
                                <select id="payment-type" class="mt-1 w-full p-2 border rounded-lg">
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Transferencia">Transferencia</option>
                                </select>
                            </div>
                             <div>
                                <label for="entry-shift" class="block text-sm font-medium">Turno</label>
                                <select id="entry-shift" class="mt-1 w-full p-2 border rounded-lg">
                                    <option value="Mañana">Mañana</option>
                                    <option value="Tarde">Tarde</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 lg:col-span-3">
                                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Guardar Ingreso</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Resumen y lista de ingresos -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Registro del Mes</h3>
                            <div>
                                <button id="prev-month" class="px-3 py-1 bg-gray-200 rounded-lg">&lt;</button>
                                <span id="current-month-display" class="font-semibold mx-4"></span>
                                <button id="next-month" class="px-3 py-1 bg-gray-200 rounded-lg">&gt;</button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-center">
                            <div class="bg-gray-100 p-3 rounded-lg">
                                <p class="text-sm text-gray-500">Saldo Mes Anterior</p>
                                <p id="prev-month-balance" class="text-lg font-bold"></p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-lg">
                                <p class="text-sm text-gray-500">Total Compras</p>
                                <p id="month-total" class="text-lg font-bold text-green-700"></p>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-lg">
                                <p class="text-sm text-gray-500">Total Pagado</p>
                                <p id="month-paid" class="text-lg font-bold text-yellow-700"></p>
                            </div>
                            <div class="bg-red-100 p-3 rounded-lg">
                                <p class="text-sm text-gray-500">Saldo Actual</p>
                                <p id="month-balance" class="text-lg font-bold text-red-700"></p>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3">Fecha</th>
                                        <th class="p-3">Producto</th>
                                        <th class="p-3">Total</th>
                                        <th class="p-3">Pagado</th>
                                        <th class="p-3">Saldo</th>
                                        <th class="p-3">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="entries-table-body">
                                    <!-- Filas se insertarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ===== PÁGINA DE PRODUCTOS ===== -->
                <div id="products-page" class="page">
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                            <h2 class="text-2xl font-bold mb-4">Añadir Producto</h2>
                            <form id="product-form">
                                <input type="hidden" id="product-id">
                                <div class="mb-4">
                                    <label for="product-name" class="block text-sm font-medium">Nombre</label>
                                    <input type="text" id="product-name" class="mt-1 w-full p-2 border rounded-lg" required>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Guardar Producto</button>
                            </form>
                        </div>
                        <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                             <h3 class="text-xl font-bold mb-4">Lista de Productos</h3>
                             <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-50">
                                        <tr><th class="p-3">Nombre</th><th class="p-3">Acciones</th></tr>
                                    </thead>
                                    <tbody id="products-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== PÁGINA DE PROVEEDORES ===== -->
                <div id="suppliers-page" class="page">
                     <div class="grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                            <h2 class="text-2xl font-bold mb-4">Añadir Proveedor</h2>
                            <form id="supplier-form">
                                <input type="hidden" id="supplier-id">
                                <div class="mb-4">
                                    <label for="supplier-name" class="block text-sm font-medium">Nombre</label>
                                    <input type="text" id="supplier-name" class="mt-1 w-full p-2 border rounded-lg" required>
                                </div>
                                <div class="mb-4">
                                    <label for="supplier-address" class="block text-sm font-medium">Dirección</label>
                                    <input type="text" id="supplier-address" class="mt-1 w-full p-2 border rounded-lg">
                                </div>
                                <div class="mb-4">
                                    <label for="supplier-phone" class="block text-sm font-medium">Teléfono</label>
                                    <input type="text" id="supplier-phone" class="mt-1 w-full p-2 border rounded-lg">
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Guardar Proveedor</button>
                            </form>
                        </div>
                        <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                             <h3 class="text-xl font-bold mb-4">Lista de Proveedores</h3>
                             <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-50">
                                        <tr><th class="p-3">Nombre</th><th class="p-3">Teléfono</th><th class="p-3">Acciones</th></tr>
                                    </thead>
                                    <tbody id="suppliers-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- REGISTRO DEL SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => console.log('ServiceWorker registrado con éxito:', registration.scope))
                    .catch(error => console.log('Fallo en el registro de ServiceWorker:', error));
            });
        }
        
        // --- VARIABLES GLOBALES Y ESTADO ---
        let db;
        let currentMonthDate = new Date();
        const DBNAME = 'GestorInventarioDB';
        const DBVERSION = 1;

        // --- ELEMENTOS DEL DOM ---
        const pages = document.querySelectorAll('.page');
        const navButtons = document.querySelectorAll('.nav-btn');
        const loginPage = document.getElementById('login-page');
        const mainContent = document.getElementById('main-content');
        
        // --- INICIALIZACIÓN DE LA BASE DE DATOS ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DBNAME, DBVERSION);

                request.onerror = event => reject('Error al abrir la BD');
                
                request.onsuccess = event => {
                    db = event.target.result;
                    console.log('Base de datos abierta con éxito');
                    resolve();
                };
                
                request.onupgradeneeded = event => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('suppliers')) {
                        db.createObjectStore('suppliers', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('entries')) {
                        const entriesStore = db.createObjectStore('entries', { keyPath: 'id', autoIncrement: true });
                        entriesStore.createIndex('date', 'date', { unique: false });
                    }
                };
            });
        }
        
        // --- LÓGICA DE NAVEGACIÓN Y AUTENTICACIÓN ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId)?.classList.add('active');
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            // Lógica de autenticación simple. Reemplazar por una más segura si es necesario.
            if (user === 'admin' && pass === 'admin123') {
                loginPage.classList.remove('active');
                mainContent.style.display = 'block';
                sessionStorage.setItem('loggedIn', 'true');
                showPage('entries-page');
                loadInitialData();
            } else {
                document.getElementById('login-error').textContent = 'Usuario o contraseña incorrectos.';
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('loggedIn');
            loginPage.classList.add('active');
            mainContent.style.display = 'none';
        });

        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const pageId = btn.getAttribute('data-page');
                showPage(pageId);
            });
        });

        // --- LÓGICA DE CRUD (Crear, Leer, Actualizar, Borrar) ---
        const crud = {
            getAll: (storeName) => new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            }),
            add: (storeName, item) => new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(item);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            }),
            delete: (storeName, id) => new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            }),
        };

        // --- LÓGICA DE PRODUCTOS ---
        const productForm = document.getElementById('product-form');
        const productsTableBody = document.getElementById('products-table-body');
        
        async function renderProducts() {
            const products = await crud.getAll('products');
            productsTableBody.innerHTML = '';
            products.forEach(p => {
                productsTableBody.innerHTML += `
                    <tr>
                        <td class="p-3">${p.name}</td>
                        <td class="p-3"><button class="text-red-500 delete-product-btn" data-id="${p.id}">Borrar</button></td>
                    </tr>`;
            });
            updateEntryFormDropdowns();
        }

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('product-name').value;
            await crud.add('products', { name });
            productForm.reset();
            renderProducts();
        });

        productsTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-product-btn')) {
                const id = parseInt(e.target.dataset.id);
                if (confirm('¿Seguro que quieres borrar este producto?')) {
                    await crud.delete('products', id);
                    renderProducts();
                }
            }
        });
        
        // --- LÓGICA DE PROVEEDORES ---
        const supplierForm = document.getElementById('supplier-form');
        const suppliersTableBody = document.getElementById('suppliers-table-body');

        async function renderSuppliers() {
            const suppliers = await crud.getAll('suppliers');
            suppliersTableBody.innerHTML = '';
            suppliers.forEach(s => {
                suppliersTableBody.innerHTML += `
                    <tr>
                        <td class="p-3">${s.name}</td>
                        <td class="p-3">${s.phone || ''}</td>
                        <td class="p-3"><button class="text-red-500 delete-supplier-btn" data-id="${s.id}">Borrar</button></td>
                    </tr>`;
            });
             updateEntryFormDropdowns();
        }

        supplierForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newSupplier = {
                name: document.getElementById('supplier-name').value,
                address: document.getElementById('supplier-address').value,
                phone: document.getElementById('supplier-phone').value,
            };
            await crud.add('suppliers', newSupplier);
            supplierForm.reset();
            renderSuppliers();
        });

        suppliersTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-supplier-btn')) {
                const id = parseInt(e.target.dataset.id);
                 if (confirm('¿Seguro que quieres borrar este proveedor?')) {
                    await crud.delete('suppliers', id);
                    renderSuppliers();
                }
            }
        });

        // --- LÓGICA DE MERCADERÍA ---
        const entryForm = document.getElementById('entry-form');
        const entryQuantity = document.getElementById('entry-quantity');
        const entryPrice = document.getElementById('entry-price');
        const entryTotal = document.getElementById('entry-total');
        const entriesTableBody = document.getElementById('entries-table-body');

        function calculateTotal() {
            const quantity = parseFloat(entryQuantity.value) || 0;
            const price = parseFloat(entryPrice.value) || 0;
            entryTotal.value = (quantity * price).toFixed(2);
        }
        entryQuantity.addEventListener('input', calculateTotal);
        entryPrice.addEventListener('input', calculateTotal);

        async function updateEntryFormDropdowns() {
            const products = await crud.getAll('products');
            const suppliers = await crud.getAll('suppliers');
            const productSelect = document.getElementById('entry-product');
            const supplierSelect = document.getElementById('entry-supplier');
            
            productSelect.innerHTML = '<option value="">Seleccione producto...</option>';
            products.forEach(p => productSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`);

            supplierSelect.innerHTML = '<option value="">Seleccione proveedor...</option>';
            suppliers.forEach(s => supplierSelect.innerHTML += `<option value="${s.name}">${s.name}</option>`);
        }

        entryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newEntry = {
                date: document.getElementById('entry-date').value,
                product: document.getElementById('entry-product').value,
                supplier: document.getElementById('entry-supplier').value,
                quantity: parseFloat(document.getElementById('entry-quantity').value),
                price: parseFloat(document.getElementById('entry-price').value),
                total: parseFloat(document.getElementById('entry-total').value),
                payment: parseFloat(document.getElementById('entry-payment').value),
                paymentType: document.getElementById('payment-type').value,
                shift: document.getElementById('entry-shift').value,
            };
            await crud.add('entries', newEntry);
            entryForm.reset();
            renderEntries();
        });

        entriesTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-entry-btn')) {
                const id = parseInt(e.target.dataset.id);
                if (confirm('¿Seguro que quieres borrar este ingreso?')) {
                    await crud.delete('entries', id);
                    renderEntries();
                }
            }
        });
        
        async function getEntriesForMonth(date) {
            return new Promise((resolve) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1).toISOString().split('T')[0];
                const lastDay = new Date(year, month + 1, 0).toISOString().split('T')[0];
                const range = IDBKeyRange.bound(firstDay, lastDay);
                
                const transaction = db.transaction('entries', 'readonly');
                const store = transaction.objectStore('entries');
                const index = store.index('date');
                const request = index.getAll(range);

                request.onsuccess = () => resolve(request.result);
            });
        }
        
        async function calculateBalanceForMonth(date) {
            const entries = await getEntriesForMonth(date);
            const balance = entries.reduce((acc, entry) => acc + (entry.total - entry.payment), 0);
            return balance;
        }

        async function renderEntries() {
            const month = currentMonthDate.getMonth();
            const year = currentMonthDate.getFullYear();
            document.getElementById('current-month-display').textContent = 
                `${currentMonthDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' })}`;

            // Saldo del mes anterior
            const prevMonth = new Date(year, month - 1, 1);
            const prevMonthBalance = await calculateBalanceForMonth(prevMonth);
            document.getElementById('prev-month-balance').textContent = prevMonthBalance.toFixed(2);
            
            // Datos del mes actual
            const entries = await getEntriesForMonth(currentMonthDate);
            entriesTableBody.innerHTML = '';
            let monthTotal = 0;
            let monthPaid = 0;

            entries.sort((a, b) => new Date(a.date) - new Date(b.date));

            entries.forEach(entry => {
                const balance = entry.total - entry.payment;
                monthTotal += entry.total;
                monthPaid += entry.payment;
                entriesTableBody.innerHTML += `
                    <tr>
                        <td class="p-3">${new Date(entry.date + 'T00:00:00').toLocaleDateString()}</td>
                        <td class="p-3">${entry.product}</td>
                        <td class="p-3">${entry.total.toFixed(2)}</td>
                        <td class="p-3">${entry.payment.toFixed(2)}</td>
                        <td class="p-3 font-bold ${balance > 0 ? 'text-red-600' : 'text-green-600'}">${balance.toFixed(2)}</td>
                        <td class="p-3"><button class="text-red-500 delete-entry-btn" data-id="${entry.id}">Borrar</button></td>
                    </tr>
                `;
            });
            
            const currentMonthBalance = monthTotal - monthPaid;
            const totalBalance = prevMonthBalance + currentMonthBalance;

            document.getElementById('month-total').textContent = monthTotal.toFixed(2);
            document.getElementById('month-paid').textContent = monthPaid.toFixed(2);
            document.getElementById('month-balance').textContent = totalBalance.toFixed(2);
        }

        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() - 1);
            renderEntries();
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
            renderEntries();
        });
        
        // --- INICIALIZACIÓN DE LA APLICACIÓN ---
        async function loadInitialData() {
            document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
            await renderProducts();
            await renderSuppliers();
            await renderEntries();
        }

        async function main() {
            await initDB();
            if (sessionStorage.getItem('loggedIn') === 'true') {
                 loginPage.classList.remove('active');
                 mainContent.style.display = 'block';
                 showPage('entries-page');
                 loadInitialData();
            } else {
                 showPage('login-page');
            }
        }
        
        main();
    });
    </script>
</body>
</html>
